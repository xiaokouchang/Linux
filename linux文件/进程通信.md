2. # 进 程 通 信
   ## 定 义
   进 程 间 通 信（IPC）是 指 打 破 进 程 隔 离、实 现 数 据 交 换 或 状 态 同 步 的 机 制，即 两 个 或 者 多 个 进 程 实 现 数 据 层 面 的 交 互。因 为 进 程 独 立 性 的 存 在，导 致 进 程 通 信 的 成 本 比 较 高。
   ***
   ## 原 因
   进 程 隔 离 是 为 了 防 止 一 个 进 程 崩 溃 或 恶 意 操 作 影 响 其 他 进 程。进 程 通 信 主 要 是 为 了 解 决 进 程 隔 离 带 来 的 “沟 通 障 碍”，需 要 进 程 通 信 解 决 以 下 核 心 需 求：
   1. **数 据 共 享**：多 个 进 程 访 问 同 一 份 数 据。
   2. **任 务 协 作**：进 程 间 分 工 配 合。
   3. **资 源 同 步**：避 免 多 个 进 程 同 时 操 作 共 享 资 源。
   4. **信 号 通 知**：进 程 间 传 递 简 单 指 令。
   ***
   ## 原 理
   1. 进 程 通 信 的 本 质 是 必 须 要 让 不 同 的 进 程 看 到 同 一 份 “资 源”。“资 源” 是 特 定 形 式 的 内 存 空 间，这 个 内 存 空 间 是 共 享 的。“资 源” 一 般 是 由 操 作 系 统 提 供。

   <font color=orange>为 什 么 资 源 不 是 由 两 个 进 程 中 的 一 个 提 供 呢？</font>
   假 设 一 个 进 程 提 供，这 个 进 程 独 有 并 且 会 将 “资 源” 共 享 出 来，这 样 会 破 坏 进 程 的 独 立 性，是 不 被 允 许 的。所 以 “资 源” 由 操 作 系 统 提 供，操 作 系 统 也 被 称 作 第 三 方 空 间。

   2. 进 程 访 问 空 间，进 行 通 信，也 就 是 进 程 要 访 问 操 作 系 统。进 程 代 表 的 就 是 用 户，“资 源” 从 创 建，使 用（一 般），释 放，操 作 系 统 为 进 程（用 户）提 供 系 统 调 用 接 口。这 些 “资 源” 操 作 系 统 会 管 理 起 来，即 `先 描 述，再 组 织`。

   3. 从 底 层 设 计，接 口 设 计 都 要 由 操 作 系 统 独 立 设 计。一 般 操 作 系 统 会 有 一 个 独 立 的 通 信 模 块，即 `IPC 通 信 模 块`。 这 个 模 块 属 于 操 作 系 统。

   4. 由 于 Linux 的 版 本 多 样 化，通 信 模 块 有 许 多 种，这 导 致 了 进 程 间 通 信 是 有 标 准 的，主 要 有 system V 和 posix。
   ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/2661496720f6490da8ca74856d22c88b.png)
   ***
   # 管 道 
   ## 定 义
   管 道 是 Unix 中 最 古 老 的 进 程 间 通 信 的 形 式，我 们 把 从 一 个 进 程 连 接 到 另 一 个 进 程 的 一 个 数 据 流 称 为 一 个 “管 道”。
   管 道 是 一 种 基 于 文 件 级 别 的 通 信 方 式，文 件 级 别 需 要 将 数 据 写 进 外 设 中，外 设 会 引 起 许 多 的 效 率 问 题。
   ## 原 理
   ### 直 观 理 解
   **wc** 统 计 有 多 少 行 记 录 的 信 息。
   ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/a797392f015a4f149d0b3eb80b7fad79.png)
   ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/4c1d1b45e68c44b8966d4df092ecad49.png)
   `who | wc -l` 这 条 指 令 中 的 `|` 就 是 管 道，who 指 令 在 运 行 的 过 程 中 就 是 进 程，类 似 的，wc 也 是 一 个 进 程。who 进 程 的 标 准 输 出 重 定 向 到 管 道 中，管 道 将 标 准 输 入 重 定 向 到 wc 进 程 中，即 一 个 进 程 从 管 道 中 读，一 个 进 程 从 管 道 中 写，就 可 以 得 到 结 果。
   在 磁 盘 中 无 论 读 写，都 需 要 将 数 据 先 加 载 到 内 存 当 中。
   ***
   ### 文 件 描 述 符
   **内 存 级 文 件**：文 件 在 磁 盘 中 不 存 在，只 需 要 在 内 存 中 能 够 使 用 即 可。

   进 程 间 通 信 的 本 质 是 需 要 让 不 同 的 进 程 看 到 同 一 份 资 源。管 道 的 本 质 就 是 文 件。

   父 子 进 程 通 信 的 过 程 中，如 果 有 一 个 进 程 将 文 件 关 闭，另 一 个 进 程 对 文 件 的 操 作 不 会 受 到 影 响，这 是 因 为 2 个 进 程 同 时 操 作 文 件，文 件 的 引 用 计 数 是 2，一 个 进 程 关 闭 文 件，引 用 计 数 减 1，当 文 件 的 引 用 计 数 为 0 时，文 件 才 会 关 闭。

   父 子 进 程 有 独 立 的 task_struct 和 文 件 描 述 符 表，文 件 是 父 子 进 程 共 享 的。
   ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/ce4aceec590048b79684a8a8b80e7bea.png)
   ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/9c08b7ae68aa4001bf6e90d7e9f333d6.png)
   ### 内 核 角 度 理 解
   管 道 不 允 许 多 个 进 程 同 时 打 开 文 件。管 道 允 许 父 子 进 程，单 向 通 信 不 允 许 双 向 通 信。如 果 进 程 读 取，则 建 议 关 闭 进 程 写 的 文 件 描 述 符。

   ==如 果 进 程 之 间 没 有 关 系，不 能 用 管 道 进 行 通 信。使 用 管 道 进 行 通 信 的 必 须 是 两 个 进 程 之 间 拥 有 血 缘 关 系，常 用 于 父 子 关 系。== 
   进 程 之 间 必 须 各 自 拥 有 文 件 描 述 符 表，如 果 文 件 描 述 符 表 共 享，会 影 响 另 一 个 进 程，这 违 背 了 进 程 的 独 立 性。

   ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/03cb9e5fe7fa4b0fafb10409f6ce2d07.png)
   建立通信信道，进程具有独立性，进程通信是有成本的。
   # 代 码 实 现
   ## pipe
   open 打 开 的 是 磁 盘 文 件，需 要 提 供 文 件 路 径，不 能 使 用 管 道 通 信。
   pipe 是 输 出 型 参 数，以 读 写 的 方 式 进 行 文 件 打 开，传 参 时 需 要 传 一 个 只 有 2 个 整 型 元 素 的 数 组 元 素。返 回 文 件 的 文 件 描 述 符 数 字。0 号 下 标 一 般 为 读，1 号 下 标 一 般 为 写。
   ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/b13ba58015f7453d820af2232600254c.png)
   ## 代 码 演 示
   ### 创 建 管 道
   **makefile**
   ```javascript
   testPipe:testPipe.cc
   	g++ -o $@ $^ -std=c++11
   .PHONY:clean
   clean:
   	rm -f testPipe 
   ```
   **testPipe.cc**
   ```javascript
   #include<iostream>
   #include<unistd.h>
   #define N 2 
   using namespace std;
   int main()
   {
       //创建管道
       int pipefd[N] = {0};
       int n = pipe(pipefd);
       if(n < 0)
       {
           return 1;
       }
       cout << "pipefd[0]:" << pipefd[0] << ",pipefd[1]:" << pipefd[1] << endl;
       return 0;
   }
   ```
   ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/d4d0749117604cf49771b4ecf21c144f.png)
   ### 创 建 子 进 程
   ```javascript
   #include<iostream>
   #include<cstdlib>  //stdlib.h
   #include<unistd.h>
   #define N 2 
   using namespace std;
   int main()
   {
       //创建管道
       int pipefd[N] = {0};
       int n = pipe(pipefd);
       if(n < 0)
       {
           return 1;
       }
       // cout << "pipefd[0]:" << pipefd[0] << ",pipefd[1]:" << pipefd[1] << endl;
       //创建子进程
       //child -> w, father -> r
       pid_t id = fork();
       if(id < 0)
       {
           return 2;
       }
       if(id == 0)
       {
           //child
           close(pipefd[0]);//关闭读的一端
           close(pipefd[1]);//结束之后关闭写
           exit(0);
       }
       close(pipefd[1]);//关闭写的一端
       return 0;
   }
   ```
   ### 读 和 写
   **snprintf**
   显 示 的 字 符 串 信 息，将 显 示 器 的 字 符 串 写 进 数 组 中。
   ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/d8dab92fa075431a99ca69d76e815e86.png)