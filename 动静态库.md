# 一、动静态库
## 库 的 制 作 者

## 库 的 使 用 者
## 动 态 库
[gcc](https://blog.csdn.net/2301_78847073/article/details/150147085?spm=1001.2014.3001.5501)
**fPIC**：产 生 位 置 无 关 码。
**mylog.h**
```javascript
#pragma once //防止头文件被重复包含
#include<stdio.h>
void log(const char*);
```
**mylog.c**
```javascript
#include"mylog.h"
void log(const char* info)
{
    printf("Warning:%s\n",info);
}
```
**myprint.c**
```javascript
#include "myprint.h"
void Print()
{
    printf("hello world!\n");
    printf("hello world!\n");
    printf("hello world!\n");
    printf("hello world!\n");
}
```
**myprint.h**
```javascript
#pragma once //防止头文件被重复包含
#include<stdio.h>
void Print();
```
**编 译 并 生 成 动 态 库**
**输 入 命 令**
1. 将 .c 文 件 编 译 成 .o 文 件
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/9fc6e7a60ab548a3af2830571f56285f.png)
2. 生 成 动 态 库
`.so` 表 示 动 态 库
`-shared` 此 选 项 表 示 不 生 成 可 执 行 程 序，将 尽 量 使 用 动 态 库，所 以 生 成 文 件 比 较 小，但 是 需 要 系 统 由 动 态 库 -O0、-O1、-O2、-O3 编 译 器 的 优 化 选 项 的 4 个 级 别，-O0 表 示 没 有 优 化，-O1 为 缺 省 值，-O3 优 化 级 别 最 高。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/9f8e51ef568b4ef4a5b3211ddc6f8983.png)

**使 用 makefile**
```javascript
dy-lib=libmymethod.so
static-lib=libmymath.a

# 同时生成动态库和静态库
.PHONY:all
all: $(dy-lib) $(static-lib)


# 生成静态库
$(static-lib):mymath.o
	ar -rc $@ $^
mymath.o:mymath.c
	gcc -c $^

# 生成动态库
$(dy-lib):mylog.o myprint.o
	gcc -shared -o $@ $^
mylog.o:mylog.c
	gcc -fPIC -c $^
myprint.o:myprint.c
	gcc -fPIC -c $^

# 清理静态库文件
.PHONY:clean
clean:
	rm -rf *.o *.a *.so mylib

# 打包
.PHONY:output
output:
	mkdir -p mylib/include
	mkdir -p mylib/lib
	cp *.h mylib/include
	cp *.a mylib/lib 
	cp *.so mylib/lib
```
**使 用 者**

1. 编 译 代 码（包 含 动 静 态 库）
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/ed948e445fbb41308847e689a90fa4e1.png)
2. 运 行 代 码
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/0fea7e4d20574c90893daccfb422de74.png)
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/0fdb5a3dcdc644ac86f1581cde5be87e.png)
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/ecaf632dafa44a20b76b33c7132a4329.png)
有 ldd 和 a.out 可 以 看 出 生 成 的 可 执 行 程 序 为 动 态 链 接 的。
gcc 编 译 时 的 路 径 是 编 译 器，还 需 要 让 系 统（加 载 器） 明 白 动 态 库 在 哪 里。

**解 决 加 载 找 不 到 动 态 库 的 方 法**
3. 将 动 态 库 拷 贝 到 系 统 路 径（/lib64 或 者 /usr/lib64/） 下。
4. 建 立 软 链 接 
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/1a14683a811c442f9560fa74eb3796cd.png) 

5. 将 自 己 的 库 所 在 的 路 径 添 加 到 系 统 的 环 境 变 量 中。使 用 `echo $LD_LIBRARY_PATH` 搜 索 用 户 自 定 义 的 库 路 径。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/93c049405c854e7e87ac9beae4ce97b7.png)
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/6bd3b856fdf34338874a1d00a2ff9757.png)
xshell 每 次 重 启 都 会 重 新 加 载 环 境 变 量，可 以 将 `LD_LIBRARY_PATH` 这 个 环 境 变 量 添 加 到 `vim ~/.bash_profile`，来 解 决 这 个 问 题。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/e90d3eaa56d94bea9451481e0af64bac.png)
6. 在 `/etc/ld.so.conf.d` 这 是 系 统 维 护 动 态 库 时 放 的 路 径，建 立 自 己 的 动 态 库 路 径 的 配 置 文 件，然 后 使 用 `ldconfig` 重 新 加 载 即 可。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/29ed7c2f85834b54b1b4398e2e0c739f.png)
7. 切 换 到 root 身 份 并 进 入 到 `/etc/ld.so.conf.d` 这 个 路 径 下，创 建 以 `.conf` 结 尾 的 文 件 并 添 加 路 径。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/78348f8d6f3f4c459b3ffb4b8472c23c.png)
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/0037a4924df144b5a7354abcb6bbacc3.png)
8. 使 用 `ldconfig` 重 新 加 载 文 件![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/ac4dbd8e5cd841bab5d7aff5e0320984.png)
3. 成 功 执 行 可 执 行 程 序
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/c26370c226ab4e4db940a54a3862dff0.png)
## 静 态 库
### 背 景
自 己 设 计 一 个 静 态 库。我 们 提 供 的 方 法 给 别 人 用。有 两 种 方 法

1. 把 源 文 件 给 他
2. 把 源 代 码 打 包 成 库，必 须 提 供 头 文 件。头 文 件 的 本 质 是 库 文 件 的 说 明 书。

libxxx.a - - - 静 态 链 接
libxxx.so - - - 动 态 链 接
### 原 理
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/f6e2758db8974e8a9fe1155ac67f2d44.png)
***
### 静 态 库 的 流 程
**编 写 者**
1. 编 写 源 代 码（不 包 括 main 函 数）。

**mymath.h**
```javascript
#pragma once 

#include<stdio.h>

extern int myerrno;
int add(int x,int y);
int sub(int x,int y);
int mul(int x,int y);
int div(int x,int y);
```
**mymath.c**
```javascript
#include"mymath.h"

int myerrno = 0;
int add(int x,int y)
{
    return x + y;
}
int sub(int x,int y)
{
    return x - y;
}
int mul(int x,int y)
{
    return x * y;
}
int div(int x,int y)
{
    if(y == 0)
    {
        myerrno = 1;
        return -1;
    }
    return x / y;
}
```
**makefile**
```javascript
lib=libmymath.a
$(lib):mymath.o
	ar -rc $@ $^
mymath.o:mymath.c
	gcc -c $^
.PHONY:clean
clean:
	rm -rf *.o *.a lib
.PHONY:output
output:
	mkdir -p lib/include
	mkdir -p lib/mymathlib
	cp *.h lib/include
	cp *.a lib/mymathlib
```
这 里 不 写 `$@` 的 原 因 是 因 为 gcc 可 以 将 `mymath.h` 编 译 成 和 源 文 件 名 字 相 同 的 `.o` 文 件。
`ar` 是 生 成 静 态 库 的 1 个 命 令，可 以 将 所 有 的 `.o` 文 件 打 包 形 成 `.a` 文 件，`-rc` 表 示 将 所 有 的 `.o` 放 在 目 标 文 件 `.a` 中，如 果 不 存 在 就 创 建，如 果 存 在 就 替 换。
**使 用 者**
1. 编 写 main 函 数。
```javascript
#include "mymath.h"
int main()
{
    int n = div(10,0);
    printf("10/0=%d,errno=%d\n",n,myerrno);
    return 0;
}
```
2. 编 译 代 码

**没 有 找 到 头 文 件**
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/a9b4d15c15d74d2a9a6fb09c231109ac.png)

编 译 器 会 在 默 认 路 径 和 当 前 目 录 下（和 源 代 码 在 同 一 级 路 径 下） 寻 找 头 文 件。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/a1ecd3ea6fdc48bbb453481185d212f1.png)
**解 决 方 法**
**方 法 1**
`gcc main.c -I + 目 录`：编 译 器 会 去 指 定 目 录 下 寻 找 头 文 件。
**方 法 2**
`#include "lib/include/mymath.h"` 可 以 在 代 码 中 包 含 路 径
***
**链 接 错 误（找 不 到 静 态 库）**
下 图 中 的 错 误 是 链 接 错 误，原 因 是 因 为 以 `.o` 结 尾 的 一 般 是 链接 错 误。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/3a4e01d0a6d9445b8f7f492e2482f11f.png)
`-c：编 译 到 目 标 代 码`
 gcc -c 编 译 通 过，只 能 说 明 代 码 在 语 法 和 基 本 编 译 规 则 上 没 有 问 题，它 不 检 查 链 接 错 误。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/472fc6cc37934b1296f995e69bc2d3fe.png)
`-L`
找 到 静 态 库。

**没 有 包 含 .a 文 件**
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/3cdaa141bd304ec8a18282e219f3d360.png)

 `-l`
 找 到 `.a` 文 件，这 里 是 静 态 库 的 真 实 名 字，建 议 -l 和 库 的 真 实 名 字 相 连 接，二 者 之 间 没 有 空 格。

**库 的 真 实 名 字**
去 掉 前 缀 和 后 缀。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/498f50f4e3a6416a8e0d10e737c1a333.png)
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/51f0e169fd3f4700b2da8e4319893f26.png)
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/6760b6ac6282476d94f007ec50ea885e.png)
***
**简 化 gcc 编 译 选 项**
1. 直 接 将 头 文 件 和 静 态 库 放 进 系 统 文 件 夹。这 是 库 的 安 装。
这 里 不 建 议 不 要 将 头 文 件 和 静 态 库 放 入 系 统 中。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/a5019f17e03e4e1cbb87d94a6ecc60eb.png)
需 要 指 明 静 态 库 的 真 实 名 字，才 能 编 译 成 功。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/6e8eec337e684ea08e4dbee4c0b86660.png)
2. 使 用 软 链 接
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/e821c0b508c6407b9ea6a9f38375b57e.png)
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/d4d761ad3cfb44c69eaf55ccd373f488.png)
3. 使 用 makefile

```javascript
main:main.c
	gcc main.c -I ./lib/include/ -L ./lib/mymathlib/ -lmymath -o main
.PHONY:clean
clean:
	rm -f main 
```
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/f8b436f3a6504650914418d57b8c1201.png)
***
### myerrno
上 面 的 errno 不 是 -1 的 原 因 是 因 为 c 语 言 的 实 例 化 是 从 右 向 左 实 例 化 的。即 `printf("10/0=%d,errno=%d\n",div(10,0),myerrno);` 这 句 代 码 中 先 调 用 myerrno 然 后 使 用 div。所 以 在 调 用 myerrno 时 应 使 用 div，然 后 使 用 myerrno。
```javascript
#include "mymath.h"
int main()
{
    int n = div(10,0);
    printf("10/0=%d,errno=%d\n",n,myerrno);
    return 0;
}
```
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/a7e27170dda0461c9cb5b9eb60bc6b3d.png)
***
### 结 论
1.  第 3 方 库 使 用 的 时 候 必 须 使 用 `-l` 选 项

2. **ldd**
可 以 查 看 是 否 是 动 态 链 接 还 是 静 态 链 接。如 下 图 gcc 采 用 的 是 动 态 链 接，因 为 文 件 是 以 `.so` 结 尾 的。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/b05a6917dc544b298031a8491b5c71fb.png)

3. gcc 默 认 是 动 态 链 接，如 果 只 提 供 静 态 链 接，gcc 只 能 对 该 库 使 用 静 态 链 接。ldd 的 输 出 反 映 的 是 整 个 程 序 是 否 依 赖 动 态 库，而 非 单 个 库 的 链 接 方 式。上 面 使 用 的 是 静 态 库，gcc 对 静 态 库 采 用 静 态 链 接，这 里 没 有 显 示 静 态 库 的 链 接。但 对 可 执 行 程 序 来 讲，程 序 中 还 有 其 他 库（如  C 标 准 库 libc）使 用 了 动 态 链 接（默 认 行 为），整 个 程 序 仍 然 是  “动 态 链 接 的 可 执 行 文 件”。 

4. 当 同 一 库 的 动 态 版 本（.so）和 静 态 版 本（.a）同 时 存 在 时，gcc 默 认 会 优 先 选 择 动 态 链 接 方 式。

5. 若 要 强 制 使 用 静 态 链 接，可 在 编 译 时 添 加 -static 选 项。不 过 需 要 注 意，-static 并 非 绝 对 强 制 的 指 令 - - - 它 的 作 用 是 告 知 gcc 尽量 采 用 静 态 链 接，但 在 某 些 情 况 下，gcc 可 能 仍 无 法 实 现 完 全 的 静 态 链 接。
## 静 态 库 与 动 态 库 是 否 具 备 可 执 行（x）权 限
### 静 态 库 无 “x” 权 限 的 原 因
静 态 库 的 核 心 作 用，是 提 供 编 译 后 的 二 进 制 代 码 片 段（而 非 源 代 码），供 编 译 链 接 阶 段 使 用。在 生 成 可 执 行 程 序 时，编 译 器 会 将 静 态 库 中 所 需 的 代 码 完 整 拷 贝 到 最 终 的 可 执 行 文 件 中 - - - 一 旦 编 译 完 成，可 执 行 程 序 就 已 包 含 静 态 库 的 全 部 必 要 功 能，后 续 运 行 时 不 再 依 赖 原 静 态 库，也 无 需 将 静 态 库 加 载 到 内 存。
由 于 静 态 库 仅 作 为 “代 码 片 段 的 容 器” 参 与 编 译，不 直 接 参 与 运 行 执 行，因 此 不 需 要 具 备 可 执 行（x）权 限。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/cf2456850e484cc3852eaf63a13e973f.png)
***
### 动 态 库 有 “x” 权 限 的 原 因
动 态 库 采 用 “运 行 时 关 联” 的 机 制：编 译 阶 段 仅 会 在 可 执 行 程 序 中 记 录 “需 要 调 用 动 态 库” 的 关 联 信 息，不 会 将 动 态 库 的 代 码 拷 贝 到 可 执 行 文 件 中。当 可 执 行 程 序 启 动 运 行 时，系 统 需 要 将 对 应 的 动 态 库 加 载 到 内 存 中，可 执 行 程 序 会 在 运 行 过 程 中 动 态 从 内 存 中 的 动 态 库 调 用 所 需 功 能。
由 于 动 态 库 需 要 被 系 统 加 载 后 直 接 执 行 其 内 部 的 代 码 逻 辑，为 了 确 保 系 统 能 正 常 读 取 并 运 行 其 指 令，动 态 库 必 须 具 备 可 执 行（x）权 限。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/57f7611f32514b0382ee67b4656ed429.png)

***