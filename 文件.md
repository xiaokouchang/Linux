# 文 件
## 基 础 知 识
1. `文 件 = 内 容 + 属 性`
2. 文 件 分 为 打 开 的 文 件 和 没 有 打 开 的 文 件。<font color=orange>进 程 打 开 的 文 件，没 打 开 的 文 件 存 储 在 磁 盘 上，没 有 打 开 的 文 件 非 常 多。</font>本 质 上 是 研 究 进 程 和 文 件 的 关 系，要 快 速 的 对 文 件 进 行 增 删 查 改。
3. 文 件 想 要 被 打 开 首 先 应 该 被 加 载 到 内 存。
4. 进 程 ：打 开 文 件 = 1:n，一 个 进 程 可 以 打 开 多 个 文 件。操 作 系 统 内 部 一 定 存 在 大 量 的 被 打 开 的 文 件。操 作 系 统 要 管 理 被 打 开 的 文 件，先 描 述，再 组 织。
5. 在 Linux 内 核 中，一 个 被 打 开 的 文 件 都 必 须 有 自 己 的 文 件 打 开 对 象，包 含 文 件 的 很 多 属 性。
## C 文 件 接 口
[C 语 言 文 件 操 作](https://blog.csdn.net/2301_78847073/article/details/147578252)
### 代 码 示 例
```javascript
#include<stdio.h>
#include<unistd.h>
int main()
{
    printf("pid:%d\n",getpid());
    //打开文件的路径和文件名,默认在当前路径下创建一个文件
    FILE* pf = fopen("test.txt","w");
    if(pf == NULL)
    {
        perror("fopen fail");
        return 1;
    }
    fclose(pf);
    sleep(100);
    return 0;
}
```
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/9cd81588daf04a7c81094699d68bebaa.png)
***
### 当 前 路 径
当 前 路 径 指 的 是 进 程 的 当 前 路 径 cwd，如 果 更 改 了 当 前 进 程 的 cwd，就 可 以 把 文 件 新 建 到 其 他 目 录。

可 以 使 用 `ll /proc/进程的PID` 来 查 看 进 程 的 当 前 路 径。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/d69393c34bec4806aa1a92980653a1f0.png)

**chdir**
更 改 进 程 的 工 作 目 录。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/08aee8ce6e0748aa84fb0fdcbbaec02d.png)
在 上 面 的 代 码 中 添 加 `chdir("/home/xpr/linux");` 可 以 更 改 进 程 的 路 径。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/14e7b69c80334f5294e8d2948f143e2e.png)
***
### 文 件 权 限
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/5a78cce3e9e9425c8414227afd707367.png)
***
#### w
将 字 符 写 入 文 件。如 果 没 有 文 件 则 会 创 建 文 件，如 果 文 件 有 内 容 则 会 清 空。
***
**fwrite**
将 字 符 写 入 到 文 件 中。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/85737e87a28342e28f4748619ac3e41b.png)
```javascript
#include<stdio.h>
#include<unistd.h>
#include<string.h>
int main()
{
    printf("pid:%d\n",getpid());
    //打开文件的路径和文件名,默认在当前路径下创建一个文件
    FILE* pf = fopen("test.txt","w");
    if(pf == NULL)
    {
        perror("fopen fail");
        return 1;
    }
    const char* str = "hello linux";
    fwrite(str,strlen(str),1,pf);
    fclose(pf);
    return 0;
}
```
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/b328f133a625488b888648d436636638.png)
***
这 里 strlen 不 需 要 加 1 原 因 是 因 为 如 果 加 1 会 出 现 乱 码，如 下 图 所 示。字 符 串 以 `\0` 结 尾 是 C 语 言 的 规 定，和 文 件 没 有 关 系。

**strlen + 1**
strlen + 1 会 在 文 件 中 出 现 `^@`，这 个 字 符 就 是 `\0`。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/c250afde50e049af9fabea99cba3315e.png)

***
[echo 及 输 入 重 定 向](https://blog.csdn.net/2301_78847073/article/details/144816581?spm=1001.2014.3001.5501)
类 似 的，echo 的 输 入 重 定 向 和 `w` 类 似，如 果 没 有 文 件 则 会 创 建，文 件 有 内 容 则 会 清 空。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/1e1a9934559c4df79fc0bb98be8f53d1.png)
#### a
在 文 件 结 尾 追 加 字 符 串，如 果 没 有 文 件 则 会 创 建 文 件。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/fede39f9335449b1ad3aa921568b18a3.png)
```javascript
#include<stdio.h>
#include<unistd.h>
#include<string.h>
int main()
{
    printf("pid:%d\n",getpid());
    //打开文件的路径和文件名,默认在当前路径下创建一个文件
    FILE* pf = fopen("test.txt","a");
    if(pf == NULL)
    {
        perror("fopen fail");
        return 1;
    }
    const char* str = "hello linux";
    fwrite(str,strlen(str)+1,1,pf);
    fclose(pf);
    return 0;
}
```
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/8bed9b88992248c0bb5157def4513c14.png)
[echo 及 输 出 重 定 向](https://blog.csdn.net/2301_78847073/article/details/144816581?spm=1001.2014.3001.5501)
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/418550ac295d4d4db9f6070319081223.png)
***
### 三 个 输 入 输 出 流
<font color=orange>所 有 的 语 言 在 启 动 时 默 认 都 会 打 开 对 应 的 设 备 文 件，原 因 是 因 为 电 脑 开 机 时 就 会 打 开 显 示 器 和 键 盘，编 写 代 码 时 使 用 键 盘 输 入，用 显 示 器 显 示。</font>C 语 言 的 3 个 输 入 输 出 流。C 程 序 默 认 在 启 动 时 会 打 开 三 个 标 准 输 入 输 出 流（文 件）。
<font color=green>所 有 的 语 言 对 于 文 件 的 操 作 都 包 括 文 件 描 述 符 fd</font>

**stdin**：键 盘
**stdout**：显 示 器 文 件
**stderr**：显 示 器 文 件
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/6ae60b8387e84ce98a6d5dab8492bde5.png)
**fprintf**
将 字 符 写 入 文 件 或 使 用 流。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/8edf61cd591c4fc5b4313bae2c4d622a.png)
```javascript
#include<stdio.h>
#include<unistd.h>
#include<string.h>
int main()
{
    printf("pid:%d\n",getpid());
    //打开文件的路径和文件名,默认在当前路径下创建一个文件
    FILE* pf = fopen("test.txt","a");
    if(pf == NULL)
    {
        perror("fopen fail");
        return 1;
    }
    const char* str = "hello linux";
    fprintf(stdout,"%s,%d\n",str,1234);
    fclose(pf);
    return 0;
}
```
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/f7cd028c7da64bf08267c884d8fd17c2.png)

## 文 件
### 基 础 知 识
文 件 其 实 是 在 磁 盘 上 的，磁 盘 是 外 部 设 备，访 问 文 件 其 实 是 访 问 硬 件。操 作 系 统 是 硬 件 的 管 理 者。几 乎 所 有 的 库 只 要 是 访 问 硬 件 设 备，必 定 要 封 装 系 统 调 用。
### open
打 开 或 者 创 建 文 件 或 者 设 备，可 以 指 定 文 件 的 权 限，即 文 件 是 否 存 在。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/b4c02bdf7f9b4b18a8d026bef8f0a404.png)
**flags**
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/63d50b8b26d1433cb873c978c7a6aff7.png)
```javascript
#include<stdio.h>
#include<unistd.h>
#include<string.h>
#include<sys/types.h>
#include<sys/stat.h>
#include<fcntl.h>
int main()
{    
    umask(0); // 文件掩码
    int fd = open("log.txt",O_WRONLY|O_CREAT,0666);
    if(fd<0)
    {
        printf("open fail\n");
        return 1;
    }
    return 0;
}
```
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/3174265f7b8e4babb4c7ff8756418854.png)
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/8987374eeea34c5282d4039964ae94e9.png)
### close
关 闭 文 件

**文 件 描 述 符**
file descriptor：文 件 描 述 符，是 int 类 型。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/ddae0db9139a469f9c75b36f322a92b8.png)
```javascript
#include<stdio.h>
#include<unistd.h>
#include<string.h>
#include<sys/types.h>
#include<sys/stat.h>
#include<fcntl.h>
int main()
{    
    umask(0); // 文件掩码
    int fd = open("log.txt",O_WRONLY|O_CREAT,0666);
    if(fd<0)
    {
        printf("open fail\n");
        return 1;
    }
    close(fd);
    return 0;
}
```
***
### write
向 文 件 中 写 入 文 件 描 述 符，返 回 值 是 实 际 写 入 的 字 节 数。默 认 从 文 件 的 开 始 处 写，不 会 对 文 件 清 空，让 新 增 加 的 字 符 替 换 掉 旧 的 字 符。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/e9e771c57ef246e185fd528b4f550f67.png)
```javascript
#include<stdio.h>
#include<unistd.h>
#include<string.h>
#include<sys/types.h>
#include<sys/stat.h>
#include<fcntl.h>
int main()
{    
    umask(0); // 文件掩码
    int fd = open("log.txt",O_WRONLY|O_CREAT,0666);
    if(fd<0)
    {
        printf("open fail\n");
        return 1;
    }
    const char* str = "hello world";
    write(fd,str,strlen(str));
    close(fd);
    return 0;
}
```
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/5265a1b8c07747fb861678e6184a4244.png)
***
### 标 志 位 传 递 方 式
1 个 整 数 可 以 传 递 1 个 标 志 位。
```javascript
#include<stdio.h>
#include<unistd.h>
#include<string.h>
#define ONE (1 << 0)  //1
#define TWO (1 << 1)  //2
#define THREE (1 << 2)//4
#define FOUR (1 << 3) //8
void show(int flags)
{
    if(flags&ONE)
    {
        printf("hello function1\n");
    }
    if(flags&TWO)
    {
        printf("hello function2\n");
    }
    if(flags&THREE)
    {
        printf("hello function3\n");
    }
    if(flags&FOUR)
    {
        printf("hello function4\n");
    }
}
int main()
{    
    show(ONE);
    printf("-----------\n");
    show(ONE|TWO);
    printf("-----------\n");
    show(ONE|TWO|THREE);
    printf("-----------\n");
    return 0;
}
```
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/81d81ffe8fb1446cba7faae0c6c597c2.png)
***
# 访 问 文 件 的 本 质
## struct file
操 作 系 统 内 描 述 一 个 被 打 开 文 件 的 信 息。

直 接 或 者 间 接 包 含 以 下 属 性：
1. 被 打 开 的 文 件 在 哪 个 位 置
2. 基 本 属 性、权 限、大 小、读 写 位 置、谁 打 开 的。
3. 文 件 的 内 核 缓 冲 区 信 息
4. struct file *next 指 针。

对 文 件 的 操 作 改 为 对 双 向 链 表 的 增 删 查 改。

一 个 进 程 可 以 打 开 多 个 文 件，要 建 立 进 程 PCB 和 打 开 文 件 的 关 系。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/fe6d71d179f5445dbe6c3f9a3f173d57.png)

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/df8a65d6e93144e5a2b8379b34c00a04.png)
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/564ce6fcc2014f13b28ce18d2052265d.png)
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/ae7ffd8fc0014da987fb198e4028a5c4.png)
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/6742cac30f2549d8994b0c81f4a3c342.png)
***
## FILE
C 语 言 中 的 `FILE` 是 C 库 中 自 己 封 装 的 结 构 体，里 面 包 含 文 件 描 述 符。
```javascript
#include<stdio.h>
#include<unistd.h>
#include<string.h>
#include<sys/types.h>
#include<sys/stat.h>
#include<fcntl.h>
int main()
{   
    printf("stdin->fd:%d\n",stdin->_fileno);
    printf("stdout->fd:%d\n",stdout->_fileno);
    printf("stderr->fd:%d\n",stderr->_fileno);
    return 0;
}
```
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/3fde3359497b4079af5a7e8aae705e4e.png)
***
## close(1)
**printf**
可 以 使 用 `close(1);` 关 闭 显 示 器 使 printf 无 法 显 示 在 显 示 屏 上。说 明 printf 的 底 层 使 用 了 1 号 文 件 描 述 符。
```javascript
#include<stdio.h>
#include<unistd.h>
#include<string.h>
#include<sys/types.h>
#include<sys/stat.h>
#include<fcntl.h>
int main()
{  
    close(1);
    printf("stdin->fd:%d\n",stdin->_fileno);
    printf("stdout->fd:%d\n",stdout->_fileno);
    printf("stderr->fd:%d\n",stderr->_fileno);
    return 0;
}
```
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/76cfc2b943274c21a10e299905a068db.png)
**fprintf**
```javascript
#include<stdio.h>
#include<unistd.h>
#include<string.h>
#include<sys/types.h>
#include<sys/stat.h>
#include<fcntl.h>
int main()
{  
    close(1);
    int ret = printf("stdin->fd:%d\n",stdin->_fileno);
    printf("stdout->fd:%d\n",stdout->_fileno);
    printf("stderr->fd:%d\n",stderr->_fileno);
    fprintf(stderr,"printf ret:%d\n",ret);
    return 0;
}
```
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/f397054f253448ee99b08b5926fba35b.png)
如 果 关 闭 了 1 号 文 件 描 述 符，使 用 2 号 文 件 描 述 符 也 可 以 在 显 示 器 上 输 出。
***
## fd
```javascript
#include<stdio.h>
#include<unistd.h>
#include<string.h>
#include<sys/types.h>
#include<sys/stat.h>
#include<fcntl.h>
int main()
{    
    umask(0); // 文件掩码
    int fd1 = open("log.txt",O_WRONLY|O_CREAT,0666);
    int fd2 = open("log.txt",O_WRONLY|O_CREAT,0666);
    int fd3 = open("log.txt",O_WRONLY|O_CREAT,0666);
    int fd4 = open("log.txt",O_WRONLY|O_CREAT,0666);
    printf("fd1:%d\n",fd1);
    printf("fd2:%d\n",fd2);
    printf("fd3:%d\n",fd3);
    printf("fd4:%d\n",fd4);
    close(fd1);
    close(fd2);
    close(fd3);
    close(fd4);
    return 0;
}
```
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/f52376c90f244b6fbd3c5cf27b1e3911.png)
***
返 回 的 整 数 值 都 是 数 组 的 下 标 且 都 是 整 数，返 回 的 整 数 值 都 是 从 3 开 始 的。0 是 stdin（键 盘 文 件），1 是 stdout（显 示 器 文 件），2 是 stderr（显 示 器 文 件）。
***
**验 证**
```javascript
#include<stdio.h>
#include<unistd.h>
#include<string.h>
#include<sys/types.h>
#include<sys/stat.h>
#include<fcntl.h>
int main()
{   
    const char* str = "hello linux";
    write(1,str,strlen(str));
    write(2,str,strlen(str));
    return 0;
}
```
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/d0fb4c552004425f9d932d73fe652667.png)
***
## read
从 文 件 描 述 符 中 读 取。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/bafd666eb687470e9ccfcd2bfab9482b.png)
```javascript
#include<stdio.h>
#include<unistd.h>
#include<string.h>
#include<sys/types.h>
#include<sys/stat.h>
#include<fcntl.h>
int main()
{   
    char buf[100];
    ssize_t count = read(0,buf,sizeof(buf));
    if(count < 0)
    {
        return 1;
    }
    buf[count] = '\0';
    printf("%s\n",buf);
    return 0;
}
```
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/a11aaf7bbd974ef4b76840153bef1ee3.png)
***
## 引 用 计 数 与 关 闭 文 件
[引 用 计 数](https://blog.csdn.net/2301_78847073/article/details/149438682?spm=1001.2014.3001.5501)
关 闭 文 件 时，使 用 close 时，对 1 号 描 述 符 的 引 用 计 数 减 1，然 后 将 1 号 指 针 位 置 置 空 即 可，然 后 判 断 引 用 计 数 是 否 为 0，如 果 为 0，则 说 明 没 有 文 件 被 使 用，系 统 会 回 收 struct 对 象。如 果 不 为 0，则 说 明 还 有 文 件 被 使 用。